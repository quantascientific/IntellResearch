<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntellResearch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://lh3.googleusercontent.com/u/1/drive-viewer/AEYQ2pSKd583H8g3K665vR_d_y8e4-8S-n8g5T8Y8D-o5kL8w5P8v2C2q4Y6j8-s8s8f8F8l8d8f8d8f8d8f8e8b8P8-q" onerror="this.onerror=null;this.src='https://placehold.co/50x50/1e3a8a/ffffff?text=Quanta'" alt="Quanta Logo" class="w-12 h-12 rounded-full">
                <h1 class="text-2xl font-bold text-gray-800">IntellResearch</h1>
            </div>
            <nav id="nav-container" class="space-x-4">
                <button id="dashboard-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Dashboard</button>
                <button id="projects-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Projects</button>
                <button id="grants-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Grants</button>
                <button id="mou-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Partnerships</button>
                <button id="mobility-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Mobility</button>
                <button id="users-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Users</button>
                <button id="reports-btn" class="text-blue-600 hover:text-blue-800 font-semibold hidden">Reports</button>
                <button id="upgrade-btn" class="py-1 px-3 bg-green-500 text-white font-semibold rounded-md hidden">Upgrade</button>
                <span id="user-info-text" class="text-gray-600 font-semibold hidden"></span>
                <button id="logout-btn" class="text-red-600 hover:text-red-800 font-semibold hidden">Logout</button>
            </nav>
        </header>

        <main class="flex-grow p-6">
            <div id="page-content" class="container mx-auto">
                </div>
        </main>
        
        <script>
            // Initialize Firebase with your project's configuration
            const firebaseConfig = {
              apiKey: "AIzaSyAsMnPa_cUvJd4NZPlTYP_7UXlguFlNXwM",
              authDomain: "intellresearch.firebaseapp.com",
              projectId: "intellresearch",
              storageBucket: "intellresearch.firebasestorage.app",
              messagingSenderId: "795386655637",
              appId: "1:795386655637:web:d969900a5897063949fc9c",
              measurementId: "G-TD95MWR2RN"
            };
            const appId = "intellresearch";
            const app = firebase.initializeApp(firebaseConfig);
            const auth = app.auth();
            const db = app.firestore();
            const storage = app.storage();

            let userId = null;
            let userRole = null;
            let userPlan = null;
            let isAuthReady = false;
            let unsubscribeFunctions = [];

            const pageContentDiv = document.getElementById('page-content');
            const navContainer = document.getElementById('nav-container');

            function showMessage(message, type = 'info') {
                const messageBox = document.createElement('div');
                messageBox.className = `p-4 rounded-lg mb-4 text-center ${type === 'error' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`;
                messageBox.textContent = message;
                pageContentDiv.prepend(messageBox);
                setTimeout(() => messageBox.remove(), 5000);
            }
            function clearPageContent() { pageContentDiv.innerHTML = ''; }

            function updateNav(isLoggedIn, role = null, plan = null) {
                const navButtons = ['dashboard-btn', 'projects-btn', 'grants-btn'];
                const roleBasedItems = {
                    'Admin': [...navButtons, 'users-btn', 'reports-btn', 'mou-btn', 'mobility-btn'],
                    'Staff': [...navButtons, 'mou-btn', 'mobility-btn'],
                    'Researcher': navButtons,
                };
                document.querySelectorAll('#nav-container button').forEach(btn => btn.classList.add('hidden'));
                document.getElementById('logout-btn').classList.toggle('hidden', !isLoggedIn);
                document.getElementById('user-info-text').classList.toggle('hidden', !isLoggedIn);
                document.getElementById('upgrade-btn').classList.toggle('hidden', !isLoggedIn || plan !== 'Free');
                
                if (isLoggedIn && role) {
                    const visibleItems = roleBasedItems[role] || [];
                    visibleItems.forEach(btnId => document.getElementById(btnId).classList.remove('hidden'));
                    document.getElementById('user-info-text').textContent = `User: ${userId ? userId.substring(0, 8) + '...' : ''} (${role}) | Plan: ${plan || 'Free'}`;
                }
            }

            function renderLoginPage() {
                clearPageContent();
                const loginHtml = `
                    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-6 text-center">Login / Register</h2>
                        <form id="auth-form" class="space-y-4">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                            </div>
                            <div>
                                <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                                <select id="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="Researcher">Researcher</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <button type="submit" id="login-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Login
                            </button>
                            <button type="button" id="register-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Register
                            </button>
                        </form>
                    </div>
                `;
                pageContentDiv.innerHTML = loginHtml;
                setupAuthFormListeners();
            }

            function setupAuthFormListeners() {
                const authForm = document.getElementById('auth-form');
                if (authForm) {
                    const loginBtn = document.getElementById('login-btn');
                    const registerBtn = document.getElementById('register-btn');

                    loginBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        try {
                            await auth.signInWithEmailAndPassword(email, password);
                        } catch (error) {
                            console.error('Login error:', error);
                            showMessage('Login failed. Please check your email and password.', 'error');
                        }
                    });

                    registerBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const role = document.getElementById('role').value;
                        try {
                            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                            await db.collection(`/artifacts/${appId}/users/${userCredential.user.uid}/roles`).doc(userCredential.user.uid).set({
                                role: role,
                                email: email,
                                plan: 'Free'
                            });
                            showMessage('Registration successful! Redirecting to plan selection...', 'info');
                            renderSubscribePage(userCredential.user.uid);
                        } catch (error) {
                            console.error('Registration error:', error);
                            showMessage('Registration failed. Please try again with a different email.', 'error');
                        }
                    });
                }
            }
            
            async function renderSubscribePage(uid) {
                clearPageContent();
                const subscribeHtml = `
                    <div class="max-w-4xl mx-auto p-8 rounded-lg shadow-lg bg-white">
                        <h2 class="text-3xl font-bold text-center mb-8">Choose Your Plan</h2>
                        <p class="text-center text-gray-600 mb-8">You can start with the free plan and upgrade at any time.</p>
                        <div id="pricing-plans" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="border p-6 rounded-lg shadow-md text-center">
                                <h3 class="text-xl font-bold mb-2">Free</h3>
                                <p class="text-gray-500 mb-4">Students, Early-Career Researchers</p>
                                <p class="text-3xl font-bold mb-4">Free</p>
                                <ul class="text-left space-y-2 mb-6">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Basic reference management</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Limited storage (100 MB)</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Basic collaboration (1-2)</li>
                                </ul>
                                <button data-plan="Free" class="w-full py-2 px-4 rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 font-semibold">Choose Plan</button>
                            </div>
                            <div class="border p-6 rounded-lg shadow-md text-center">
                                <h3 class="text-xl font-bold mb-2">Individual Pro</h3>
                                <p class="text-gray-500 mb-4">Active Researchers, Professors</p>
                                <p class="text-3xl font-bold mb-4">$5<span class="text-sm font-normal text-gray-500">/mo</span></p>
                                <ul class="text-left space-y-2 mb-6">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Unlimited references</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Increased storage (5 GB)</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Advanced collaboration (5-10)</li>
                                </ul>
                                <button data-plan="Pro" class="w-full py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">Choose Plan</button>
                            </div>
                            <div class="border p-6 rounded-lg shadow-md text-center">
                                <h3 class="text-xl font-bold mb-2">Research Group</h3>
                                <p class="text-gray-500 mb-4">Research Labs, Small Departments</p>
                                <p class="text-3xl font-bold mb-4">$4<span class="text-sm font-normal text-gray-500">/user/mo</span></p>
                                <ul class="text-left space-y-2 mb-6">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Everything in Pro</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Group management tools</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Shared storage & library</li>
                                </ul>
                                <button data-plan="Group" class="w-full py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">Choose Plan</button>
                            </div>
                             <div class="border p-6 rounded-lg shadow-md text-center">
                                <h3 class="text-xl font-bold mb-2">Institutional</h3>
                                <p class="text-gray-500 mb-4">Universities, Research Institutes</p>
                                <p class="text-3xl font-bold mb-4">Custom</p>
                                <ul class="text-left space-y-2 mb-6">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Everything in Group</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Centralized admin</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>SSO & API access</li>
                                </ul>
                                <button data-plan="Institutional" class="w-full py-2 px-4 rounded-md text-white bg-gray-600 hover:bg-gray-700 font-semibold">Contact Us</button>
                            </div>
                        </div>
                    </div>
                `;
                pageContentDiv.innerHTML = subscribeHtml;
                setupSubscribeListeners(uid);
            }

            async function setupSubscribeListeners(uid) {
                document.querySelectorAll('#pricing-plans button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const plan = e.target.dataset.plan;
                        try {
                            await db.collection(`/artifacts/${appId}/users/${uid}/roles`).doc(uid).update({ plan: plan });
                            if (plan === 'Free') {
                                showMessage(`Plan successfully set to Free. Redirecting to dashboard...`, 'success');
                                setTimeout(() => window.location.reload(), 1500);
                            } else if (plan === 'Institutional') {
                                showMessage("Thank you for your interest. Please contact our sales team.", 'info');
                            } else {
                                showMessage(`Plan set to ${plan}. This is a client-side prototype, so no payment is required. You can now use your new features.`, 'info');
                                setTimeout(() => window.location.reload(), 1500);
                            }
                        } catch (error) {
                            console.error('Error updating plan:', error);
                            showMessage("Failed to update plan. Please try again.", 'error');
                        }
                    });
                });
            }

            async function renderDashboard() {
                clearPageContent();
                unsubscribeListeners();
                pageContentDiv.innerHTML = `<h2 class="text-3xl font-semibold mb-6">Analytics & Reporting Dashboard</h2>`;
                const reportsSection = document.createElement('div');
                reportsSection.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                reportsSection.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800">Projects by Status</h3>
                        <div id="project-status-chart" class="mt-4 h-40 flex items-center justify-center">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800">Grants by Status</h3>
                        <div id="grant-status-chart" class="mt-4 h-40 flex items-center justify-center">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-800">Recent Audit Log</h3>
                        <div id="audit-log-list" class="mt-4 text-sm text-gray-600 space-y-2">Loading...</div>
                    </div>
                `;
                pageContentDiv.appendChild(reportsSection);

                if (isAuthReady) {
                    try {
                        const projectSnapshot = await db.collection(`/artifacts/${appId}/public/data/projects`).get();
                        const grantSnapshot = await db.collection(`/artifacts/${appId}/public/data/grants`).get();
                        const auditLogSnapshot = await db.collection(`/artifacts/${appId}/public/data/auditLogs`).orderBy('timestamp', 'desc').limit(5).get();
                        const projectStatus = {};
                        projectSnapshot.forEach(doc => { const data = doc.data(); projectStatus[data.status] = (projectStatus[data.status] || 0) + 1; });
                        renderSimpleChart('project-status-chart', projectStatus);
                        const grantStatus = {};
                        grantSnapshot.forEach(doc => { const data = doc.data(); grantStatus[data.status] = (grantStatus[data.status] || 0) + 1; });
                        renderSimpleChart('grant-status-chart', grantStatus);
                        const auditLogList = document.getElementById('audit-log-list');
                        auditLogList.innerHTML = '';
                        auditLogSnapshot.forEach(doc => {
                            const data = doc.data();
                            const logItem = document.createElement('div');
                            logItem.className = 'border-b border-gray-200 pb-2 last:border-b-0';
                            logItem.textContent = `${new Date(data.timestamp.toDate()).toLocaleString()} - ${data.action} by User ${data.userId ? data.userId.substring(0, 8) + '...' : 'Unknown'}`;
                            auditLogList.appendChild(logItem);
                        });
                    } catch (error) {
                        console.error("Error fetching dashboard data:", error);
                        showMessage("Failed to load dashboard data. Please check permissions.", "error");
                    }
                }
            }
            
            function renderSimpleChart(elementId, data) {
                const chartElement = document.getElementById(elementId);
                chartElement.innerHTML = '';
                const total = Object.values(data).reduce((sum, count) => sum + count, 0);
                if (total === 0) { chartElement.textContent = 'No data available.'; return; }
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500'];
                let colorIndex = 0;
                const barsContainer = document.createElement('div');
                barsContainer.className = 'flex w-full h-full';
                for (const key in data) {
                    const bar = document.createElement('div');
                    const percentage = (data[key] / total) * 100;
                    bar.className = `h-full ${colors[colorIndex % colors.length]} transition-all duration-500`;
                    bar.style.width = `${percentage}%`;
                    barsContainer.appendChild(bar);
                    colorIndex++;
                }
                chartElement.appendChild(barsContainer);
                const legend = document.createElement('div');
                legend.className = 'mt-2 text-xs';
                Object.keys(data).forEach((key, index) => {
                    const legendItem = document.createElement('span');
                    legendItem.className = `mr-3 text-gray-600`;
                    const colorBlock = document.createElement('span');
                    colorBlock.className = `inline-block w-3 h-3 rounded-full ${colors[index % colors.length]} mr-1`;
                    legendItem.appendChild(colorBlock);
                    legendItem.append(`${key}: ${data[key]} (${((data[key] / total) * 100).toFixed(1)}%)`);
                    legend.appendChild(legendItem);
                });
                chartElement.parentNode.appendChild(legend);
            }

            function renderProjectsPage() {
                clearPageContent();
                unsubscribeListeners();
                pageContentDiv.innerHTML = `
                    <h2 class="text-3xl font-semibold mb-6">Research Projects</h2>
                    ${userRole === 'Admin' || userRole === 'Staff' ? `
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Add New Project</h3>
                        <form id="project-form" class="space-y-4">
                            <div>
                                <label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label>
                                <input type="text" id="project-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="project-status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="project-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Planning</option>
                                    <option>In Progress</option>
                                    <option>Completed</option>
                                    <option>Archived</option>
                                </select>
                            </div>
                            <div>
                                <label for="project-grant" class="block text-sm font-medium text-gray-700">Associated Grant (Optional)</label>
                                <input type="text" id="project-grant" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="project-pi" class="block text-sm font-medium text-gray-700">Principal Investigator (Name or Email)</label>
                                <input type="text" id="project-pi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="project-description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea id="project-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md shadow-sm">Add Project</button>
                        </form>
                    </div>` : ''}
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Project List</h3>
                        <div id="project-list" class="space-y-4">Loading projects...</div>
                    </div>
                `;
                setupProjectListeners();
                if (isAuthReady) {
                    listenForProjects();
                }
            }

            function setupProjectListeners() {
                const form = document.getElementById('project-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const data = {
                            name: document.getElementById('project-name').value,
                            status: document.getElementById('project-status').value,
                            grant: document.getElementById('project-grant').value,
                            principalInvestigator: document.getElementById('project-pi').value,
                            description: document.getElementById('project-description').value,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: userId,
                            appId: appId
                        };
                        try {
                            await db.collection(`/artifacts/${appId}/public/data/projects`).add(data);
                            await addAuditLog('Project added');
                            showMessage('Project added successfully!');
                            form.reset();
                        } catch (error) {
                            console.error("Error adding document: ", error);
                            showMessage("Failed to add project. Please try again.", "error");
                        }
                    });
                }
            }
            
            function listenForProjects() {
                const q = db.collection(`/artifacts/${appId}/public/data/projects`);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const projectList = document.getElementById('project-list');
                    if (!projectList) return;
                    projectList.innerHTML = '';
                    if (querySnapshot.empty) {
                        projectList.innerHTML = '<p class="text-gray-500">No projects found.</p>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const project = doc.data();
                        const projectElement = document.createElement('div');
                        projectElement.className = 'p-4 border border-gray-200 rounded-lg flex justify-between items-start';
                        projectElement.innerHTML = `
                            <div>
                                <h4 class="text-lg font-medium">${project.name}</h4>
                                <p class="text-sm text-gray-600">Status: <span class="font-semibold">${project.status}</span></p>
                                <p class="text-xs text-gray-500 mt-1">${project.description}</p>
                            </div>
                            <div class="space-x-2">
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="update-project-btn text-blue-500 hover:text-blue-700 text-sm">Edit</button>` : ''}
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="delete-project-btn text-red-500 hover:text-red-700 text-sm">Delete</button>` : ''}
                            </div>
                        `;
                        projectList.appendChild(projectElement);
                    });
                    attachCrudListeners('project');
                }, (error) => {
                    console.error("Error listening for projects:", error);
                    showMessage("Failed to load projects. Check console for details.", "error");
                });
                unsubscribeFunctions.push(unsubscribe);
            }
            
            function renderGrantsPage() {
                clearPageContent();
                unsubscribeListeners();
                pageContentDiv.innerHTML = `
                    <h2 class="text-3xl font-semibold mb-6">Grant & Funding Tracking</h2>
                    ${userRole === 'Admin' || userRole === 'Staff' ? `
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Add New Grant</h3>
                        <form id="grant-form" class="space-y-4">
                            <div>
                                <label for="grant-name" class="block text-sm font-medium text-gray-700">Grant Name</label>
                                <input type="text" id="grant-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="grant-source" class="block text-sm font-medium text-gray-700">Source (Internal/External)</label>
                                <select id="grant-source" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Internal</option>
                                    <option>External</option>
                                </select>
                            </div>
                            <div>
                                <label for="grant-amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                                <input type="number" id="grant-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="grant-status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="grant-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Applied</option>
                                    <option>Awarded</option>
                                    <option>Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label for="grant-file" class="block text-sm font-medium text-gray-700">Upload Grant Document (PDF, DOCX)</label>
                                <input type="file" id="grant-file" class="mt-1 block w-full text-gray-700" accept=".pdf, .docx, .doc">
                            </div>
                            <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md shadow-sm">Add Grant</button>
                        </form>
                    </div>` : ''}
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Grant List</h3>
                        <div id="grant-list" class="space-y-4">Loading grants...</div>
                    </div>
                `;
                setupGrantListeners();
                if (isAuthReady) {
                    listenForGrants();
                }
            }

            function setupGrantListeners() {
                const form = document.getElementById('grant-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const file = document.getElementById('grant-file').files[0];
                        const data = {
                            name: document.getElementById('grant-name').value,
                            source: document.getElementById('grant-source').value,
                            amount: parseFloat(document.getElementById('grant-amount').value),
                            status: document.getElementById('grant-status').value,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: userId,
                            appId: appId
                        };
                        try {
                            if (file) {
                                const fileName = `${new Date().getTime()}_${file.name}`;
                                const storageRef = storage.ref(`grants/${fileName}`);
                                await storageRef.put(file);
                                data.fileUrl = await storageRef.getDownloadURL();
                            }
                            await db.collection(`/artifacts/${appId}/public/data/grants`).add(data);
                            await addAuditLog('Grant added');
                            showMessage('Grant added successfully!');
                            form.reset();
                        } catch (error) {
                            console.error("Error adding grant: ", error);
                            showMessage("Failed to add grant. Please try again.", "error");
                        }
                    });
                }
            }

            function listenForGrants() {
                const q = db.collection(`/artifacts/${appId}/public/data/grants`);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const grantList = document.getElementById('grant-list');
                    if (!grantList) return;
                    grantList.innerHTML = '';
                    if (querySnapshot.empty) {
                        grantList.innerHTML = '<p class="text-gray-500">No grants found.</p>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const grant = doc.data();
                        const grantElement = document.createElement('div');
                        grantElement.className = 'p-4 border border-gray-200 rounded-lg flex justify-between items-start';
                        grantElement.innerHTML = `
                            <div>
                                <h4 class="text-lg font-medium">${grant.name}</h4>
                                <p class="text-sm text-gray-600">Source: ${grant.source} | Amount: $${grant.amount} | Status: <span class="font-semibold">${grant.status}</span></p>
                                ${grant.fileUrl ? `<a href="${grant.fileUrl}" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 block">View Document</a>` : ''}
                            </div>
                            <div class="space-x-2">
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="update-grant-btn text-blue-500 hover:text-blue-700 text-sm">Edit</button>` : ''}
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="delete-grant-btn text-red-500 hover:text-red-700 text-sm">Delete</button>` : ''}
                            </div>
                        `;
                        grantList.appendChild(grantElement);
                    });
                    attachCrudListeners('grant');
                }, (error) => {
                    console.error("Error listening for grants:", error);
                    showMessage("Failed to load grants. Check console for details.", "error");
                });
                unsubscribeFunctions.push(unsubscribe);
            }

            function renderMouPage() {
                clearPageContent();
                unsubscribeListeners();
                pageContentDiv.innerHTML = `
                    <h2 class="text-3xl font-semibold mb-6">MOU & Institutional Partnerships</h2>
                    ${userRole === 'Admin' || userRole === 'Staff' ? `
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Add New Partnership</h3>
                        <form id="mou-form" class="space-y-4">
                            <div>
                                <label for="mou-partner" class="block text-sm font-medium text-gray-700">Partner Institution</label>
                                <input type="text" id="mou-partner" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="mou-type" class="block text-sm font-medium text-gray-700">Agreement Type</label>
                                <input type="text" id="mou-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="mou-status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="mou-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Draft</option>
                                    <option>Active</option>
                                    <option>Expired</option>
                                </select>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md shadow-sm">Add Partnership</button>
                        </form>
                    </div>` : ''}
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Partnership List</h3>
                        <div id="mou-list" class="space-y-4">Loading partnerships...</div>
                    </div>
                `;
                setupMouListeners();
                if (isAuthReady) {
                    listenForMous();
                }
            }

            function setupMouListeners() {
                const form = document.getElementById('mou-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const data = {
                            partner: document.getElementById('mou-partner').value,
                            type: document.getElementById('mou-type').value,
                            status: document.getElementById('mou-status').value,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: userId,
                            appId: appId
                        };
                        try {
                            await db.collection(`/artifacts/${appId}/public/data/mous`).add(data);
                            await addAuditLog('Partnership added');
                            showMessage('Partnership added successfully!');
                            form.reset();
                        } catch (error) {
                            console.error("Error adding partnership: ", error);
                            showMessage("Failed to add partnership. Please try again.", "error");
                        }
                    });
                }
            }

            function listenForMous() {
                const q = db.collection(`/artifacts/${appId}/public/data/mous`);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const mouList = document.getElementById('mou-list');
                    if (!mouList) return;
                    mouList.innerHTML = '';
                    if (querySnapshot.empty) {
                        mouList.innerHTML = '<p class="text-gray-500">No partnerships found.</p>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const mou = doc.data();
                        const mouElement = document.createElement('div');
                        mouElement.className = 'p-4 border border-gray-200 rounded-lg flex justify-between items-start';
                        mouElement.innerHTML = `
                            <div>
                                <h4 class="text-lg font-medium">${mou.partner}</h4>
                                <p class="text-sm text-gray-600">Type: ${mou.type} | Status: <span class="font-semibold">${mou.status}</span></p>
                            </div>
                            <div class="space-x-2">
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="update-mou-btn text-blue-500 hover:text-blue-700 text-sm">Edit</button>` : ''}
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="delete-mou-btn text-red-500 hover:text-red-700 text-sm">Delete</button>` : ''}
                            </div>
                        `;
                        mouList.appendChild(mouElement);
                    });
                    attachCrudListeners('mou');
                }, (error) => {
                    console.error("Error listening for partnerships:", error);
                    showMessage("Failed to load partnerships. Check console for details.", "error");
                });
                unsubscribeFunctions.push(unsubscribe);
            }

            function renderMobilityPage() {
                clearPageContent();
                unsubscribeListeners();
                pageContentDiv.innerHTML = `
                    <h2 class="text-3xl font-semibold mb-6">Student & Staff Mobility</h2>
                    ${userRole === 'Admin' || userRole === 'Staff' ? `
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Add New Mobility Log</h3>
                        <form id="mobility-form" class="space-y-4">
                            <div>
                                <label for="mobility-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="mobility-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="mobility-type" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="mobility-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Student</option>
                                    <option>Staff</option>
                                </select>
                            </div>
                            <div>
                                <label for="mobility-destination" class="block text-sm font-medium text-gray-700">Destination</label>
                                <input type="text" id="mobility-destination" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="mobility-date" class="block text-sm font-medium text-gray-700">Travel Date</label>
                                <input type="date" id="mobility-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md shadow-sm">Add Log</button>
                        </form>
                    </div>` : ''}
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Mobility Log List</h3>
                        <div id="mobility-list" class="space-y-4">Loading mobility logs...</div>
                    </div>
                `;
                setupMobilityListeners();
                if (isAuthReady) {
                    listenForMobility();
                }
            }

            function setupMobilityListeners() {
                const form = document.getElementById('mobility-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const data = {
                            name: document.getElementById('mobility-name').value,
                            type: document.getElementById('mobility-type').value,
                            destination: document.getElementById('mobility-destination').value,
                            date: document.getElementById('mobility-date').value,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: userId,
                            appId: appId
                        };
                        try {
                            await db.collection(`/artifacts/${appId}/public/data/mobility`).add(data);
                            await addAuditLog('Mobility log added');
                            showMessage('Mobility log added successfully!');
                            form.reset();
                        } catch (error) {
                            console.error("Error adding mobility log: ", error);
                            showMessage("Failed to add log. Please try again.", "error");
                        }
                    });
                }
            }
            
            function listenForMobility() {
                const q = db.collection(`/artifacts/${appId}/public/data/mobility`);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    const mobilityList = document.getElementById('mobility-list');
                    if (!mobilityList) return;
                    mobilityList.innerHTML = '';
                    if (querySnapshot.empty) {
                        mobilityList.innerHTML = '<p class="text-gray-500">No mobility logs found.</p>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const mobility = doc.data();
                        const mobilityElement = document.createElement('div');
                        mobilityElement.className = 'p-4 border border-gray-200 rounded-lg flex justify-between items-start';
                        mobilityElement.innerHTML = `
                            <div>
                                <h4 class="text-lg font-medium">${mobility.name}</h4>
                                <p class="text-sm text-gray-600">Type: ${mobility.type} | Destination: ${mobility.destination} | Date: ${mobility.date}</p>
                            </div>
                            <div class="space-x-2">
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="update-mobility-btn text-blue-500 hover:text-blue-700 text-sm">Edit</button>` : ''}
                                ${userRole === 'Admin' || userRole === 'Staff' ? `<button data-id="${doc.id}" class="delete-mobility-btn text-red-500 hover:text-red-700 text-sm">Delete</button>` : ''}
                            </div>
                        `;
                        mobilityList.appendChild(mobilityElement);
                    });
                    attachCrudListeners('mobility');
                }, (error) => {
                    console.error("Error listening for mobility logs:", error);
                    showMessage("Failed to load logs. Check console for details.", "error");
                });
                unsubscribeFunctions.push(unsubscribe);
            }

            function attachCrudListeners(collectionName) {
                const pageElement = document.getElementById('page-content');
                pageElement.querySelectorAll(`.delete-${collectionName}-btn`).forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.dataset.id;
                        if (await confirmModal(`Are you sure you want to delete this ${collectionName}?`)) {
                            try {
                                await db.collection(`/artifacts/${appId}/public/data/${collectionName}s`).doc(id).delete();
                                await addAuditLog(`${collectionName} deleted`);
                                showMessage(`${collectionName} deleted successfully!`);
                            } catch (error) {
                                console.error(`Error deleting ${collectionName}:`, error);
                                showMessage(`Failed to delete ${collectionName}.`, 'error');
                            }
                        }
                    });
                });
                pageElement.querySelectorAll(`.update-${collectionName}-btn`).forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.dataset.id;
                        showMessage(`Edit functionality for ${collectionName} with ID ${id} is not yet implemented.`, 'info');
                    });
                });
            }

            function confirmModal(message) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50';
                modal.innerHTML = `
                    <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">${message}</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">This action cannot be undone.</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Delete
                                </button>
                                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 ml-2">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                return new Promise(resolve => {
                    document.getElementById('modal-confirm-btn').addEventListener('click', () => { modal.remove(); resolve(true); });
                    document.getElementById('modal-cancel-btn').addEventListener('click', () => { modal.remove(); resolve(false); });
                });
            }

            function unsubscribeListeners() {
                unsubscribeFunctions.forEach(unsub => unsub());
                unsubscribeFunctions = [];
            }
            async function addAuditLog(action) {
                if (!isAuthReady) return;
                try {
                    await db.collection(`/artifacts/${appId}/public/data/auditLogs`).add({
                        action: action,
                        userId: userId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error adding audit log:", error);
                }
            }

            async function renderUsersPage() {
                clearPageContent();
                if (userRole !== 'Admin') { pageContentDiv.innerHTML = `<p class="text-red-500 font-semibold text-lg">You do not have permission to view this page.</p>`; return; }
                const userManagementHtml = `
                    <h2 class="text-3xl font-semibold mb-6">User Management</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">User List</h3>
                            <div class="relative w-64">
                                <input type="text" id="search-user" placeholder="Search by email..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                        </div>
                        <div id="user-list" class="space-y-4">Loading users...</div>
                    </div>
                `;
                pageContentDiv.innerHTML = userManagementHtml;
                listenForUsers();
                document.getElementById('search-user').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const userItems = document.querySelectorAll('.user-item');
                    userItems.forEach(item => {
                        const email = item.querySelector('.user-email').textContent.toLowerCase();
                        if (email.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            function listenForUsers() {
                const q = db.collectionGroup('roles');
                const unsubscribe = q.onSnapshot(querySnapshot => {
                    const userListEl = document.getElementById('user-list');
                    if (!userListEl) return;
                    userListEl.innerHTML = '';
                    if (querySnapshot.empty) { userListEl.innerHTML = '<p class="text-gray-500">No users found.</p>'; return; }
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        const userUid = doc.id;
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item p-4 border border-gray-200 rounded-lg flex justify-between items-start cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                        userElement.dataset.uid = userUid;
                        userElement.addEventListener('click', () => renderUserDetailPage(userUid));
                        userElement.innerHTML = `
                            <div>
                                <h4 class="user-email text-lg font-medium">${userData.email || 'Email not available'}</h4>
                                <p class="text-sm text-gray-600">Role: <span class="font-semibold">${userData.role}</span> | Plan: <span class="font-semibold">${userData.plan || 'N/A'}</span></p>
                                <p class="text-xs text-gray-500 mt-1">UID: ${userUid}</p>
                            </div>
                        `;
                        userListEl.appendChild(userElement);
                    });
                }, error => {
                    console.error("Error listening for users:", error);
                    showMessage("Failed to load users. Check console for details.", "error");
                });
                unsubscribeFunctions.push(unsubscribe);
            }

            async function renderUserDetailPage(uid) {
                clearPageContent();
                const userRoleDoc = await db.collection(`/artifacts/${appId}/users/${uid}/roles`).doc(uid).get();
                if (!userRoleDoc.exists) { showMessage("User not found.", "error"); return; }
                const userData = userRoleDoc.data();
                const userDetailHtml = `
                    <h2 class="text-3xl font-semibold mb-6">User Details</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg space-y-4">
                        <div>
                            <p class="text-sm text-gray-500">Email</p>
                            <p class="font-medium">${userData.email || 'Email not available'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">UID</p>
                            <p class="font-medium">${uid}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Current Role</p>
                            <p class="font-medium">${userData.role}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Current Plan</p>
                            <p class="font-medium">${userData.plan || 'N/A'}</p>
                        </div>
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="text-xl font-semibold mb-4">Update Role</h3>
                            <form id="update-role-form" class="space-y-4">
                                <div>
                                    <label for="new-user-role-select" class="block text-sm font-medium text-gray-700">New Role</label>
                                    <select id="new-user-role-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option value="Researcher">Researcher</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md shadow-sm">Update Role</button>
                            </form>
                        </div>
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <h3 class="text-xl font-semibold mb-4">Delete User</h3>
                            <button id="delete-user-btn" data-uid="${uid}" class="py-2 px-4 bg-red-600 text-white rounded-md shadow-sm">Delete User</button>
                            <p class="text-sm text-red-500 mt-2">This action cannot be undone. For security, this feature requires server-side logic and is a placeholder in this prototype.</p>
                        </div>
                    </div>
                `;
                pageContentDiv.innerHTML = userDetailHtml;
                document.getElementById('new-user-role-select').value = userData.role;
                setupUpdateRoleListener(uid);
                setupDeleteUserListener(uid);
            }

            function setupUpdateRoleListener(uid) {
                const form = document.getElementById('update-role-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newRole = document.getElementById('new-user-role-select').value;
                    try {
                        const userRoleDocRef = db.collection(`/artifacts/${appId}/users/${uid}/roles`).doc(uid);
                        await userRoleDocRef.update({ role: newRole });
                        showMessage(`Successfully updated role for user to ${newRole}!`);
                        renderUsersPage();
                    } catch (error) {
                        console.error("Error updating user role:", error);
                        showMessage(`Failed to update user role. Check console for details.`, 'error');
                    }
                });
            }

            function setupDeleteUserListener(uid) {
                const button = document.getElementById('delete-user-btn');
                button.addEventListener('click', async () => {
                    if (await confirmModal(`Are you sure you want to delete this user?`)) {
                        showMessage(`Attempting to delete user with UID: ${uid}. This feature is disabled in the prototype for security.`, 'error');
                    }
                });
            }
            
            async function renderReportsPage() {
                clearPageContent();
                if (userRole !== 'Admin') { pageContentDiv.innerHTML = `<p class="text-red-500 font-semibold text-lg">You do not have permission to view this page.</p>`; return; }
                const reportsHtml = `
                    <h2 class="text-3xl font-semibold mb-6">Detailed Reports</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Projects Report</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto border-collapse">
                                <thead class="bg-gray-200 text-gray-700">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Project Name</th>
                                        <th class="px-4 py-2 text-left">Status</th>
                                        <th class="px-4 py-2 text-left">Description</th>
                                        <th class="px-4 py-2 text-left">Associated Grant</th>
                                        <th class="px-4 py-2 text-left">Principal Investigator</th>
                                    </tr>
                                </thead>
                                <tbody id="projects-report-table-body" class="text-gray-600">
                                    <tr><td colspan="5" class="text-center py-4">Loading reports...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                pageContentDiv.innerHTML = reportsHtml;
                if (isAuthReady) { loadProjectsReport(); }
            }

            async function loadProjectsReport() {
                const tableBody = document.getElementById('projects-report-table-body');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Loading reports...</td></tr>';
                try {
                    const projectsRef = db.collection(`/artifacts/${appId}/public/data/projects`);
                    const projectsSnapshot = await projectsRef.get();
                    const projects = projectsSnapshot.docs.map(doc => doc.data());
                    if (projects.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No projects found.</td></tr>'; return; }
                    tableBody.innerHTML = '';
                    for (const project of projects) {
                        let grantAmount = 'N/A';
                        if (project.grant) {
                            const grantRef = db.collection(`/artifacts/${appId}/public/data/grants`).where('name', '==', project.grant);
                            const grantSnapshot = await grantRef.get();
                            if (!grantSnapshot.empty) { grantAmount = `$${grantSnapshot.docs[0].data().amount.toLocaleString()}`; }
                        }
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        row.innerHTML = `
                            <td class="px-4 py-2">${project.name}</td>
                            <td class="px-4 py-2">${project.status}</td>
                            <td class="px-4 py-2">${project.description || 'N/A'}</td>
                            <td class="px-4 py-2">${project.grant || 'N/A'}</td>
                            <td class="px-4 py-2">${project.principalInvestigator || 'N/A'}</td>
                        `;
                        tableBody.appendChild(row);
                    }
                } catch (error) {
                    console.error("Error loading projects report:", error);
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load report.</td></tr>';
                }
            }

            function setupNavigation() {
                document.getElementById('dashboard-btn').addEventListener('click', renderDashboard);
                document.getElementById('projects-btn').addEventListener('click', renderProjectsPage);
                document.getElementById('grants-btn').addEventListener('click', renderGrantsPage);
                document.getElementById('mou-btn').addEventListener('click', renderMouPage);
                document.getElementById('mobility-btn').addEventListener('click', renderMobilityPage);
                document.getElementById('users-btn').addEventListener('click', renderUsersPage);
                document.getElementById('reports-btn').addEventListener('click', renderReportsPage);
                document.getElementById('upgrade-btn').addEventListener('click', () => renderSubscribePage(userId));
                document.getElementById('logout-btn').addEventListener('click', async () => { await auth.signOut(); showMessage('Logged out successfully.'); });
            }
            
            auth.onAuthStateChanged(async (user) => {
                isAuthReady = false;
                unsubscribeListeners();
                if (user) {
                    userId = user.uid;
                    try {
                        const userRoleDocRef = db.collection(`/artifacts/${appId}/users/${userId}/roles`).doc(userId);
                        const docSnap = await userRoleDocRef.get();
                        if (docSnap.exists) {
                            userRole = docSnap.data().role;
                            userPlan = docSnap.data().plan;
                            updateNav(true, userRole, userPlan);
                            isAuthReady = true;
                            if (docSnap.data().plan === 'Free') {
                                renderSubscribePage(userId);
                            } else if (!pageContentDiv.innerHTML.trim()) {
                                renderDashboard();
                            }
                        } else {
                            console.warn("User role not found. Logging out.");
                            await auth.signOut();
                        }
                    } catch (error) {
                        console.error("Error fetching user role:", error);
                        await auth.signOut();
                    }
                } else {
                    userId = null;
                    userRole = null;
                    userPlan = null;
                    updateNav(false);
                    renderLoginPage();
                }
            });

            window.onload = function() {
                renderLoginPage();
                setupNavigation();
            };
        </script>
    </div>
</body>
</html>
